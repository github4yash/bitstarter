<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Bitstarter by github4yash</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Bitstarter</h1>
        <p class="header">My bitstarter project - startup engineering</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/github4yash/bitstarter/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/github4yash/bitstarter/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/github4yash/bitstarter">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/github4yash">github4yash</a></p>


      </header>
      <section>
        <h1>
<a id="preamble" class="anchor" href="#preamble" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Preamble</h1>

<p>This codebase here has been forked and modified using the instructions below. 
So this code is ready to be used whereas the instructions below walk you through the 
steps you need to do to get to this state.</p>

<p>I have deployed this code at <a href="http://github4yash-bitstarter-mooc.herokuapp.com">Heroku</a> check it out.</p>

<h1>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Overview</h1>

<p>This is a simple template app for a Bitcoin-based crowdfunding site that
adds even more server-side and client-side dynamic behavior over our
<a href="https://github.com/startup-class/bitstarter-ssjs-db">earlier template</a>. It
uses three of the four technologies in the so-called
<a href="http://mean.io">MEAN stack</a>: <a href="http://expressjs.com">Express</a> (E),
<a href="http://angularjs.com">Angular</a> (A), and <a href="http://nodejs.com">Node</a> (N), and
replaces <a href="http://mongodb.com">MongoDB</a> / <a href="http://mongoosejs.com">Mongoose</a>
(M) with <a href="http://postgresql.org">PostgreSQL</a> /
<a href="http://sequelizejs.com">Sequelize</a>. The app illustrates several of the
following conceptual topics:</p>

<ul>
<li><p>Implementing multiple routes
(<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/web.js#L89">1</a>,
<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/routes.js#L111">2</a>)</p></li>
<li><p>Factoring out constants/settings into separate files
(<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/constants.js">1</a>,
<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/routes.js#L43">2</a>)</p></li>
<li><p>Factoring out secure server-side configuration variables into <code>.env</code> files 
(<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/.env.dummy">1</a>, 
 <a href="https://devcenter.heroku.com/articles/config-vars">2</a>)</p></li>
<li><p>Using <code>async.series</code> to force a database update, followed by a launch of the
webserver
(<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/web.js#L97">1</a>)</p></li>
<li><p>Using <code>async.mapLimit</code> and <code>async.eachLimit</code> to limit the number of simultaneous queries to a remote API and to a database respectively
(<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/models/coinbase.js#L60">1</a>, 
 <a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/models/order.js#L73">2</a>)</p></li>
<li><p>Using asynchronous code to set up a recurring background process (a "daemon")
(<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/web.js#L110">1</a>)</p></li>
<li><p>Visualizing ORM instances in the browser
(<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/routes.js#L55">1</a>,
<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/views/orderpage.ejs#L24">2</a>)</p></li>
<li><p>Client-side templating with <a href="http://angularjs.org">AngularJS</a>
(<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/views/homepage.ejs#L70">1</a>,
<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/public/js/controllers.js#L17">2</a>,
<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/routes.js#L61">3</a>)</p></li>
<li><p>Server-side templating with <a href="http://embeddedjs.com/">Embedded JS templates</a>
(<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/routes.js#L42">1</a>,
<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/views/homepage.ejs">2</a>,
<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/routes.js#L55">3</a>,
<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/views/orderpage.ejs">4</a>)</p></li>
<li><p>Making a request to a remote API both on the server and in client-side code
(<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/models/order.js#L138">1</a>,
<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/models/coinbase.js#L42">2</a>,
<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/models/coinbase.js#L54">3</a>,
<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/public/js/controllers.js#L18">4</a>)</p></li>
<li><p>Setting up a simple API
(<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/routes.js#L61">1</a>,
 <a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/public/js/controllers.js#L16">2</a>)</p></li>
<li><p>Reusing code by putting object manipulation code into instance/class methods
(<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/routes.js#L83">1</a>,
<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/web.js#L101">2</a>,
<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/web.js#L112">3</a>)</p></li>
<li><p>Setting up a basic AngularJS controller
(<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/views/homepage.ejs#L70">1</a>,
<a href="https://github.com/startup-class/bitstarter-leaderboard/blob/master/public/js/controllers.js#L17">2</a>)</p></li>
</ul>

<p>Let's install the app and then take a tour of the functionality.</p>

<h1>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Installation</h1>

<p>To get the app up and running, execute the following commands on your EC2
instance:</p>

<div class="highlight highlight-source-shell"><pre>curl https://raw.github.com/startup-class/setup/master/setup.sh <span class="pl-k">|</span> bash
<span class="pl-c1">exit</span> <span class="pl-c"># and then log in again</span>
git clone https://github.com/startup-class/bitstarter-leaderboard.git
<span class="pl-c1">cd</span> bitstarter-leaderboard
./setup-ssjs.sh</pre></div>

<h2>
<a id="running-locally-on-an-ec2-instance" class="anchor" href="#running-locally-on-an-ec2-instance" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Running Locally on an EC2 Instance</h2>

<p>Once you have done this you will need to :</p>

<ol>
<li>Copy the <a href=".env.dummy">.env.dummy</a> file into <code>.env</code> and include your API
key from <a href="http://coinbase.com/account/integrations">http://coinbase.com/account/integrations</a> so that it looks like the
snippet below. Note that <code>COINBASE_API_KEY</code> is a secure API key that should
never be checked into a git repository; that's why we exclude it in the
<a href=".gitignore">.gitignore</a>.</li>
</ol>

<div class="highlight highlight-source-shell"><pre>$ cp .env.dummy .env
$ emacs -nw .env  <span class="pl-c"># Add key from coinbase.com/account/integrations</span>
$ cat .env
COINBASE_API_KEY=cb27e2ef0a8872f7923612d4d57937e70476ab8041455b00b35d1196cf80f50d
PORT=8080</pre></div>

<ol>
<li>Edit the <a href=".constants.js">constants.js</a> file to include the
preorder button from <a href="http://coinbase.com/merchant_tools">http://coinbase.com/merchant_tools</a>. This is a non-secure
code that is meant to be embedded in a public-facing webpage, so it's ok if
you check this into git.</li>
</ol>

<div class="highlight highlight-source-js"><pre>  COINBASE_PREORDER_DATA_CODE<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>13b56883764b54e6ab56fef3bcc7229c<span class="pl-pds">"</span></span>,</pre></div>

<ol>
<li>Now you can run the server locally and preview at a URL like
<a href="http://ec2-54-213-131-228.us-west-2.compute.amazonaws.com:8080">http://ec2-54-213-131-228.us-west-2.compute.amazonaws.com:8080</a> as follows:</li>
</ol>

<div class="highlight highlight-source-shell"><pre>foreman start</pre></div>

<p>You can determine the hostname of your EC2 instance conveniently with this
command:</p>

<div class="highlight highlight-source-shell"><pre>curl -s http://169.254.169.254/latest/meta-data/public-hostname
<span class="pl-c"># ec2-54-213-192-71.us-west-2.compute.amazonaws.com</span></pre></div>

<p>Try placing some orders and then going to the "/orders" URL at the top to
see them recorded. Also refresh the page to see the thermometer update. Note
that you will get an error if you didn't do the <code>.env</code> step above.</p>

<h2>
<a id="running-remotely" class="anchor" href="#running-remotely" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Running Remotely</h2>

<p>Once the app works via <code>foreman start</code> on your EC2 machine, you can deploy to Heroku and push
the configuration variables defined in <code>.env</code> as follows:</p>

<div class="highlight highlight-source-shell"><pre>git push heroku master
heroku config:push</pre></div>

<p>Then you can go to a URL like <a href="http://safe-dawn-4440.herokuapp.com">http://safe-dawn-4440.herokuapp.com</a> and submit
orders to test it out. Note again that you will get an "invalid api key"
error if you didn't do the <code>.env</code> step above.</p>

<h1>
<a id="concepts" class="anchor" href="#concepts" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Concepts</h1>

<h2>
<a id="file-structure" class="anchor" href="#file-structure" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>File Structure</h2>

<p>Let's begin by taking a quick look at the files in the app. First, the major
differences from
<a href="http://github.com/startup-class/bitstarter-ssjs-db">github.com/startup-class/bitstarter-ssjs-db</a>
are as follows:</p>

<ul>
<li>  <code>index.html</code> is now replaced by the more sophisticated <code>views/homepage.ejs</code> template</li>
<li>  <code>.pgpass</code> has a newline added to it, and a corresponding</li>
<li>  CSS and JS have been pulled out of index.html and into <code>public/css</code> and <code>public/js</code>
</li>
<li>  A good deal of content has been added to the static files directory to
reduce the number of HTTP requests to external servers.</li>
</ul>

<p>Now let's go file by file:</p>

<table>
<thead>
<tr>
<th align="right">Path</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="right"><a href=".env.dummy">.env.dummy</a></td>
<td align="left">Used as template for .env. Has COINBASE_API_KEY from coinbase.com/account/integrations</td>
</tr>
<tr>
<td align="right"><a href=".pgpass">.pgpass</a></td>
<td align="left">Used by pgsetup.sh to instantiate the db</td>
</tr>
<tr>
<td align="right"><a href="constants.js">constants.js</a></td>
<td align="left">Several constants, including COINBASE_PREORDER_DATA_CODE from coinbase.com/merchant_tools</td>
</tr>
<tr>
<td align="right"><a href="models/coinbase.js">models/coinbase.js</a></td>
<td align="left">Define a set of functions that downloads and parses remote Order data from Coinbase</td>
</tr>
<tr>
<td align="right"><a href="models/index.js">models/index.js</a></td>
<td align="left">Initialize the connection between Sequelize and the PostgreSQL db.</td>
</tr>
<tr>
<td align="right"><a href="models/order.js">models/order.js</a></td>
<td align="left">Define an Order class that works with data from the "Order" table in the PostgreSQL db</td>
</tr>
<tr>
<td align="right"><a href="package.json">package.json</a></td>
<td align="left">Specify dependencies for the app</td>
</tr>
<tr>
<td align="right"><a href="pgsetup.sh">pgsetup.sh</a></td>
<td align="left">Invoked by setup-ssjs.sh to create the Postgres DB.</td>
</tr>
<tr>
<td align="right"><a href="Procfile">Procfile</a></td>
<td align="left">Heroku file that determines which processes are run upon deployment</td>
</tr>
<tr>
<td align="right"><a href="public/css/bitstarter-styles.css">public/css/bitstarter-styles.css</a></td>
<td align="left">CSS styles for views/homepage.ejs</td>
</tr>
<tr>
<td align="right"><a href="public/fonts/opensans-300.woff">public/fonts/opensans-300.woff</a></td>
<td align="left">Google Font file</td>
</tr>
<tr>
<td align="right"><a href="public/fonts/ubuntu-300.woff">public/fonts/ubuntu-300.woff</a></td>
<td align="left">Google Font file</td>
</tr>
<tr>
<td align="right"><a href="public/fonts/ubuntu-700.woff">public/fonts/ubuntu-700.woff</a></td>
<td align="left">Google Font file</td>
</tr>
<tr>
<td align="right"><a href="public/img/480x300.gif">public/img/480x300.gif</a></td>
<td align="left">Placeholder image</td>
</tr>
<tr>
<td align="right"><a href="public/img/favicon.ico">public/img/favicon.ico</a></td>
<td align="left">Favorite icon ('favicon') for bookmarks/favorites</td>
</tr>
<tr>
<td align="right"><a href="public/js/angular.min.js">public/js/angular.min.js</a></td>
<td align="left">Angular JS file (see angularjs.org). Used for thermometer on frontpage.</td>
</tr>
<tr>
<td align="right"><a href="public/js/coinbase-post-payment.js">public/js/coinbase-post-payment.js</a></td>
<td align="left">Stub code to use once Coinbase fixes the coinbase_payment_complete event.</td>
</tr>
<tr>
<td align="right"><a href="public/js/controllers.js">public/js/controllers.js</a></td>
<td align="left">Angular JS controllers. Contains controller for the thermometer in homepage.ejs.</td>
</tr>
<tr>
<td align="right"><a href="public/js/google-analytics.js">public/js/google-analytics.js</a></td>
<td align="left">One of the two Google Analytics scripts. For ga.js.</td>
</tr>
<tr>
<td align="right"><a href="README.md">README.md</a></td>
<td align="left">Documentation</td>
</tr>
<tr>
<td align="right"><a href="routes.js">routes.js</a></td>
<td align="left">Define the routes for the app: functions executed when specific URLs are requested.</td>
</tr>
<tr>
<td align="right"><a href="setup-ssjs.sh">setup-ssjs.sh</a></td>
<td align="left">Set up an EC2 instance. Invokes pgsetup.sh</td>
</tr>
<tr>
<td align="right"><a href="views/homepage.ejs">views/homepage.ejs</a></td>
<td align="left">Template for the index (served up for example.com/)</td>
</tr>
<tr>
<td align="right"><a href="views/orderpage.ejs">views/orderpage.ejs</a></td>
<td align="left">Template for the order page (served up for example.com/orders)</td>
</tr>
<tr>
<td align="right"><a href="web.js">web.js</a></td>
<td align="left">Initialize express app, syncs db, and start HTTP server</td>
</tr>
</tbody>
</table>

<h1>
<a id="server-side" class="anchor" href="#server-side" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Server-Side</h1>

<h2>
<a id="express-e-in-mean" class="anchor" href="#express-e-in-mean" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Express ('E' in MEAN)</h2>

<p>We use <a href="http://expressjs.org">Express</a> to set up our web server. Skim the
Express <a href="http://expressjs.org">documentation</a> and then take a look at
<a href="web.js">web.js</a>
and
<a href="routes.js">routes.js</a>
to see how we set up the app and the valid routes. We've also factored out
many static assets into subdirectories into <a href="public/">/public</a>.</p>

<p>Recall again that static assets are files that do not change. When users
request <code>example.com/img/480x300.gif</code> they will get the same file every time
(a static response). By contrast, a web page with content that changes based
on client- or server-side parameters is a dynamic web page; for example,
when a user requests <code>example.com/orders</code> they will see something that
depends on the state of the database and thus will vary over time.</p>

<p>Note that in <a href="routes.js">routes.js</a>, we try to separate the code that
handles requests and responses from the code that actually manipulates
instances of the <a href="models/order.js">Order</a> class. This illustrates a general
principle: as much as possible, you should ask objects to manipulate
themselves with instance methods and/or class methods rather than try to
work with an object's guts externally; see
<a href="models/order.js">models/order.js</a> for details of doing this. We'll talk
more about how this is done in the
<a href="dborm-postgresql-and-sequelize-replaces-m-in-mean">ORM section</a> below, but
for now note that most request handlers have the form of asking <code>global.db</code>
for some data and then packing that data into an HTTP response of some kind.</p>

<p>In sum, Express is used here to organize the functions that are executed on
the server to generate an HTTP response from an HTTP request - that is, to
structure our webapp.</p>

<h2>
<a id="server-side-templating" class="anchor" href="#server-side-templating" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Server-Side Templating</h2>

<p>For illustrative purposes, we do two kinds of templating in this app:
server-side templating of <a href="views/homepage.ejs">views/homepage.ejs</a> and <a href="views/orderpage.ejs">views/orderpage.ejs</a>, and
client-side templating in the thermometer on the homepage via Angular JS
(also in <a href="views/homepage.ejs#L70">views/homepage.ejs</a>.</p>

<p>Let's talk about server-side templating first. The specific templating
engine here is set up in <a href="web.js">web.js</a>, where we tell Express that <code>.ejs</code>
(<a href="http://embeddedjs.com">Embedded Javascript</a>) files are our templates of choice via the line
<a href="web.js#L82">app.set('view engine', 'ejs')</a>.</p>

<p>Consider <a href="routes.js#L41">indexfn</a> in routes.js. This uses
<a href="http://expressjs.com/api.html#res.render">response.render</a> to take the file
<code>views/homepage.ejs</code> and populate it with a JSON data structure. Specifically,
the <a href="routes.js#L42">response.render invocation</a> looks for variables in
<code>views/homepage.ejs</code> (like
<a href="views/homepage.ejs#L115">&lt;%= coinbase_preorder_data_code %&gt;</a> ) and replaces
them with the corresponding field of the JSON data structure as defined in
<a href="constants.js#L33">constants.js</a>. It then wraps this in an HTTP response and
returns it to the client.</p>

<p>A slightly more complex example is in <a href="routes.js#L53">orderfn</a>, also in
<code>routes.js</code>.  Here we use the <code>orders_json</code> JSON data structure to populate
the <code>views/orderpage.ejs</code> file via <code>response.render</code>, similar to what we did
in <code>indexfn</code>. The main difference is that we put this logic
in a callback and send it into
<a href="models/order.js#L28">global.db.Order.allToJSON</a>, executing it right after
the <code>orders</code> variable is built up via ORM and database operations.</p>

<p>These two examples illustrate the basic idea of server-side
templating. Rather than returning a fully static file like
<code>public/img/480x300.gif</code>, we separate out the static and dynamic
portions. We put the parts that don't change (the static parts) into a
template like <code>views/orderpage.ejs</code> and then populate this template
dynamically with the remainder, returning the response to the client. All of
this is done on the server and the computation is invisible to the client;
they can't view the <code>orders</code> variable directly, for example, by looking at
<a href="http://net.tutsplus.com/tutorials/chrome-dev-tools-networking-and-the-console/">Network Requests</a>
in the Chrome Developer Tools. They just see one HTTP response in response
to their HTTP request.</p>

<h2>
<a id="dborm-postgresql-and-sequelize-replaces-m-in-mean" class="anchor" href="#dborm-postgresql-and-sequelize-replaces-m-in-mean" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>DB/ORM: PostgreSQL and Sequelize (Replaces 'M' in MEAN)</h2>

<p>In this app we have a simple PostgreSQL relational database underlying the
app that keeps a local mirror of the remote order data on Coinbase's
servers. We create the db by running <a href="setup-ssjs.sh">setup-ssjs.sh</a>, which
in turn invokes <a href="pgsetup.sh">pgsetup.sh</a>. We interface with this database
via the Sequelize Object-Relational Mapper (ORM), which provides a
Javascript API to a relational database. The following figure provides an
overview; take a look at it and then read the subsequent documentation:</p>

<div>
  <img width="100%" src="https://d396qusza40orc.cloudfront.net/startup/images/bitstarter-leaderboard/fig1.png">
</div>

<p>While this kind of setup is canonical, it's worth asking a few questions
about why a relational database and object-relational mapper combination is
so common in web applications today.</p>

<ul>
<li><p><em>Why use a DB?</em> First, you might ask why we don't simply keep the order data
in a simple <code>.json</code> file and then reload it when the app boots up. This is
the so-called 'flatfile' approach. We could certainly do this, but as our
app scales and we get more and more data this approach has issues. For one
thing, we would find it painful to modify the <code>.json</code> file simultaneously if
we had multiple web-servers writing to the same dataset. For another, a
naive <code>.json</code> file saved on disk will be very slow to search. As a third
point, we may wish to extract information from this <code>.json</code> file in a
different manner from the way in which we saved it. Each of these things -
parallelized reads/writes, rapid searching, and easy reporting via the
Structured Query Language (SQL) - is facilitated by converting our data from
flatfiles and keeping it in a relational database like PostgreSQL.</p></li>
<li><p><em>Why use an ORM with the DB?</em> Second, given that we are using a relational
database, you might then ask why we don't simply interface directly with the
relational database via a low-level library like <code>node-postgres</code>, which
allows us to run SQL statements directly against the database. Why take on
the overhead of an Object-Relational Mapper like Sequelize? The answer is
that the so-called 'Active Record Paradigm' is a good match for many
webapps. In a nutshell, the idea is that it is often very useful to conceive
of tables in a relational database as mapping directly to classes, while
rows of these tables contain the data for instances. In this framework the
entire database can be thought of as an elaborate
serialization/deserialization apparatus for Javascript objects. You
rehydrate individual instances of JS classes from disk during the life of a
program, and then dehydrate them and put them in cold storage (the
relational database) when no longer needed in memory. That said, it's
important to keep in mind that an ORM is a convenience and not a panacea:
just as with flatfiles it is true that sometimes the Active Record paradigm
breaks down and you need to directly interface with the database via SQL
statements, for performance reasons or because you're doing some sort of
report or dashboard that accesses the data via columns even though you saved
it across rows.</p></li>
<li><p><em>Why use a relational DB rather than a NoSQL DB?</em> As a third point, you
might note that this combination of Sequelize and PostgreSQL replaces the
Mongoose/MongoDB combination which is the 'M' in the MEAN stack. Why don't
we just use the so-called <a href="http://en.wikipedia.org/wiki/NoSQL">NoSQL</a>
Mongoose/MongoDB combo? Well, Mongoose/MongoDB is certainly one way to go if
you really want a completely full-stack JS app. However, PostgreSQL has
excellent support for JS and JSON nowadays, and is more mature than
MongoDB. Moreover, the advantages of a so-called schemaless or NoSQL
approach are greatest at the beginning of an app when the
<a href="http://en.wikipedia.org/wiki/Database_schema">schema</a> is changing rapidly,
but eventually it actually becomes useful to have a schema to catch errors
and prevent invalid operations. You will often find yourself reinventing a
schema in code if you go down the MongoDB path, albeit without the extent of
low-level schema support provided by a relational DB like PostgreSQL.</p></li>
</ul>

<p>Once we've decided on an ORM/DB combination, in general we want to keep most
code related to manipulating data from the database in the corresponding
class or instance methods (in our case in <code>models/order.js</code>). As a rough
rule of thumb, class methods operate on every instance in the class
(e.g. counts and totals), while instance methods access data associated with
particular instances. So as an example you'd use a class method (like
<code>Order.totals</code>) to sum up the total amount of Bitcoin sent over all orders,
while you'd use an instance method (like a hypothetical
<code>myorder.amountInUSD</code> method) to determine the equivalent USD amount for a
given order in BTC. The latter method call needs the amount data on a
specific <code>Order</code> instance, so it should be an instance method (though you
might request and cache the exchange rate itself via a class method).</p>

<p>We put these class and instance method definitions in <code>order.js</code>, within the
the <code>sequelize.define</code> invocation (see <a href="http://sequelizejs.com/documentation#models-expansion-of-models">here</a>). The main tricky part here is
the value of <code>this</code>. Within a class method it refers to the entire class (in
this case <code>Order</code>) while within an instance method it refers to a particular
instance (e.g. <code>myorder</code>). Sometimes you need to save this variable and pass
it in to a callback; we do this in <code>addFromJSON</code> to make the <code>Order</code> class
accessible within a callback that runs on each individual instance. </p>

<p>Finally, here are some examples of working with the ORM in the node REPL.</p>

<div class="highlight highlight-source-js"><pre>    <span class="pl-c">// Execute from within the top level directory after pgsetup:</span>
    <span class="pl-k">&gt;</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>./models<span class="pl-pds">'</span></span>)
    <span class="pl-k">&gt;</span> <span class="pl-c1">global</span>.<span class="pl-smi">db</span>.<span class="pl-smi">Order</span>.<span class="pl-en">numOrders</span>()
    Executing<span class="pl-k">:</span> <span class="pl-c1">SELECT</span> <span class="pl-en">count</span>(<span class="pl-k">*</span>) as <span class="pl-s"><span class="pl-pds">"</span>count<span class="pl-pds">"</span></span> <span class="pl-c1">FROM</span> <span class="pl-s"><span class="pl-pds">"</span>Orders<span class="pl-pds">"</span></span>;
    There are <span class="pl-c1">25</span> Orders

    <span class="pl-k">&gt;</span> <span class="pl-k">var</span> foo <span class="pl-k">=</span> [];
    <span class="pl-k">&gt;</span> <span class="pl-c1">global</span>.<span class="pl-smi">db</span>.<span class="pl-smi">Order</span>.<span class="pl-en">findAll</span>().<span class="pl-en">success</span>(<span class="pl-k">function</span>(<span class="pl-smi">_orders</span>) { <span class="pl-c1">global</span>[<span class="pl-s"><span class="pl-pds">'</span>foo<span class="pl-pds">'</span></span>].<span class="pl-c1">push</span>(_orders);});
    <span class="pl-k">&gt;</span> <span class="pl-k">var</span> orders <span class="pl-k">=</span> foo[<span class="pl-c1">0</span>];
    <span class="pl-k">&gt;</span> orders[<span class="pl-c1">0</span>].<span class="pl-en">repr</span>()
    { coinbase_id<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>84XZQO6L<span class="pl-pds">'</span></span>,
      amount<span class="pl-k">:</span> <span class="pl-c1">0.0001</span>,
      time<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>2013-08-10T10:31:33-07:00<span class="pl-pds">'</span></span>,
      id<span class="pl-k">:</span> <span class="pl-c1">131</span>,
      createdAt<span class="pl-k">:</span> Fri Aug <span class="pl-c1">10</span> <span class="pl-c1">2013</span> <span class="pl-c1">19</span><span class="pl-k">:</span><span class="pl-c1">57</span><span class="pl-k">:</span><span class="pl-c1">29</span> <span class="pl-c1">GMT</span><span class="pl-k">+</span><span class="pl-ii">0000</span> (<span class="pl-c1">UTC</span>),
      updatedAt<span class="pl-k">:</span> Fri Aug <span class="pl-c1">10</span> <span class="pl-c1">2013</span> <span class="pl-c1">19</span><span class="pl-k">:</span><span class="pl-c1">57</span><span class="pl-k">:</span><span class="pl-c1">29</span> <span class="pl-c1">GMT</span><span class="pl-k">+</span><span class="pl-ii">0000</span> (<span class="pl-c1">UTC</span>) }</pre></div>

<h1>
<a id="client-side" class="anchor" href="#client-side" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Client-Side</h1>

<h2>
<a id="client-side-templating" class="anchor" href="#client-side-templating" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Client-Side Templating</h2>

<p>We previously discussed server-side templating and how we combine a static
template (from <code>order.ejs</code> or <code>homepage.ejs</code>) with dynamic JSON data to create
a dynamic HTTP response that varies with the state of the database. If you
recall, our <code>homepage.ejs</code> was partially templated on the server-side in the
<code>indexfn</code> within <code>routes.js</code> by replacement of the portions surrounded by
special brackets, like the value of <code>name</code> below.</p>

<div class="highlight highlight-text-html-basic"><pre>      &lt;<span class="pl-ent">span</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>icon-bar<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">span</span>&gt;
      &lt;<span class="pl-ent">span</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>icon-bar<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">span</span>&gt;
    &lt;/<span class="pl-ent">button</span>&gt;
    &lt;<span class="pl-ent">a</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>brand<span class="pl-pds">"</span></span> <span class="pl-e">href</span>=<span class="pl-s"><span class="pl-pds">"</span>#<span class="pl-pds">"</span></span>&gt;&lt;%= name %&gt;&lt;/<span class="pl-ent">a</span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>nav-collapse collapse<span class="pl-pds">"</span></span>&gt;
      &lt;<span class="pl-ent">ul</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>nav<span class="pl-pds">"</span></span>&gt;
        &lt;<span class="pl-ent">li</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>active<span class="pl-pds">"</span></span>&gt;&lt;<span class="pl-ent">a</span> <span class="pl-e">href</span>=<span class="pl-s"><span class="pl-pds">"</span>#<span class="pl-pds">"</span></span>&gt;Home&lt;/<span class="pl-ent">a</span>&gt;&lt;/<span class="pl-ent">li</span>&gt;
        &lt;<span class="pl-ent">li</span>&gt;&lt;<span class="pl-ent">a</span> <span class="pl-e">href</span>=<span class="pl-s"><span class="pl-pds">"</span>#about<span class="pl-pds">"</span></span>&gt;About&lt;/<span class="pl-ent">a</span>&gt;&lt;/<span class="pl-ent">li</span>&gt;</pre></div>

<p>However, you might have noticed an alternative bracket syntax coexisting
within the <code>homepage.ejs</code> file, as shown surrounding <code>num_orders</code> below:</p>

<div class="highlight highlight-text-html-basic"><pre>    &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>span5 actions<span class="pl-pds">"</span></span> <span class="pl-e">ng-controller</span>=<span class="pl-s"><span class="pl-pds">"</span>OrdersCtrl<span class="pl-pds">"</span></span>&gt;
      &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>row-fluid<span class="pl-pds">"</span></span>&gt;
      &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>span8 offset2<span class="pl-pds">"</span></span>&gt;
        &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>row-fluid statistics<span class="pl-pds">"</span></span>&gt;
          &lt;<span class="pl-ent">div</span> <span class="pl-e">ng-show</span>=<span class="pl-s"><span class="pl-pds">"</span>!error<span class="pl-pds">"</span></span>&gt;
            &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>span4<span class="pl-pds">"</span></span>&gt;
              <span class="pl-c">&lt;!-- linediv-l and linediv-r give dividing lines that look</span>
<span class="pl-c">              different in horizontal and vertical layouts, illustrating</span>
<span class="pl-c">              media queries. --&gt;</span>
              &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>linediv-l<span class="pl-pds">"</span></span>&gt;
              &lt;<span class="pl-ent">h3</span>&gt;{{num_orders}}&lt;/<span class="pl-ent">h3</span>&gt; &lt;<span class="pl-ent">p</span>&gt;backers&lt;/<span class="pl-ent">p</span>&gt;
              &lt;/<span class="pl-ent">div</span>&gt;
            &lt;/<span class="pl-ent">div</span>&gt;</pre></div>

<p>This is because in <code>homepage.ejs</code> we are also using a second kind of
templating: client-side templating. It is similar in concept to server-side
templating, except the population of the static template with the JSON data
occurs on the client side. Among other things, this means the client has
access to a JSON API that is returning some data. </p>

<p>In this app, the place that we're doing some client-side templating is in
the thermometer element. The data that comes from <code>/api/orders</code> is being
used to update the thermometer. If you submit an order in a separate window,
and wait for the Coinbase data to be refreshed (via the <code>setInterval</code> daemon
in <code>web.js</code>) or manually refresh it yourself (by requesting
<code>/refresh_orders</code>), the thermometer will then update upon a homepage
refresh. You can think of this client-side templating implementation as
simply populating the template variables in <code>homepage.ejs</code> with data on the
client-side rather than on the server.</p>

<h2>
<a id="angular-two-way-data-binding-a-in-mean" class="anchor" href="#angular-two-way-data-binding-a-in-mean" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Angular: Two-Way Data Binding ('A' in MEAN)</h2>

<p>But things are a little more complicated than that. We're actually using a
client-side framework called <a href="http://docs.angularjs.org/guide/concepts">AngularJS</a> which offers something much more
sophisticated than simple templating. It actually does full-on two-way
databinding; see here for the <a href="http://docs.angularjs.org/guide/dev_guide.templates.databinding">concept</a> and here for a worked <a href="http://docs.angularjs.org/guide/forms">example</a>. The
basic difference between one-way templating and two-way databinding is that
in one-way templating the data is just used to populate variables in a
template (e.g. <code>homepage.ejs</code>). In two-way databinding, however, actions on
elements of a templated page (like clicking a button or typing into a form
field) can in turn change the underlying data. Indeed, you can set it up
such that the same data is editable from several different places within a
page. Again, see here for the <a href="http://docs.angularjs.org/guide/dev_guide.templates.databinding">concept</a> and here for a worked <a href="http://docs.angularjs.org/guide/forms">example</a>. We
aren't using all the features of two-way databinding in our thermometer, but
it's worth understanding how Angular works in a simple use case.</p>

<p>To trace through the logic of how we're using Angular in our simple app,
let's start with the four Angular directives that we're using in
<code>homepage.ejs</code>: <code>ng-app</code>, <code>ng-show</code>, <code>ng-style</code>, and <code>ng-controller</code>. First,
we put <code>ng-app</code> at the top of the file and include <code>angular.min.js</code>. Once
the Javascript from <code>angular.min.js</code> is parsed and run by the browser, it
will look through the DOM, find the <code>ng-app</code> declaration, and treat
everything underneath that node as subject to control/updating by
Angular. For simplicity, in this case we put <code>ng-app</code> at the very top node,
in the <code>&lt;html&gt;</code> tag.</p>

<div class="highlight highlight-text-html-basic"><pre>    &lt;!DOCTYPE html&gt;
    &lt;<span class="pl-ent">html</span> <span class="pl-e">lang</span>=<span class="pl-s"><span class="pl-pds">"</span>en<span class="pl-pds">"</span></span> <span class="pl-e">ng-app</span>&gt;
      &lt;<span class="pl-ent">head</span>&gt;
        &lt;<span class="pl-ent">meta</span> <span class="pl-e">charset</span>=<span class="pl-s"><span class="pl-pds">"</span>utf-8<span class="pl-pds">"</span></span>&gt;
        &lt;<span class="pl-ent">title</span>&gt;&lt;%= title %&gt;&lt;/<span class="pl-ent">title</span>&gt;
        &lt;<span class="pl-ent">meta</span> <span class="pl-e">name</span>=<span class="pl-s"><span class="pl-pds">"</span>viewport<span class="pl-pds">"</span></span> <span class="pl-e">content</span>=<span class="pl-s"><span class="pl-pds">"</span>width=device-width, initial-scale=1.0<span class="pl-pds">"</span></span>&gt;
<span class="pl-s1">        &lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>https://d396qusza40orc.cloudfront.net/startup/code/jquery.js<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">        &lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>https://d396qusza40orc.cloudfront.net/startup/code/bootstrap.js<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">        &lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>js/angular.min.js<span class="pl-pds">"</span></span> &gt;&lt;/<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">        &lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>js/controllers.js<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;</span>
    ...</pre></div>

<p>Then, towards the middle of the file, we use three directives: <code>ng-show</code>,
<code>ng-style</code>, and <code>ng-controller</code>. Of these, <code>ng-controller</code> is the most
important. It sets up a relationship between this div and the code in
<code>public/js/controllers.js</code>, which defines the <code>OrdersCtrl</code> function. If you
look at <a href="public/js/controllers.js">public/js/controllers.js</a>, it initiates an HTTP request to
<code>/api/orders</code>, and uses the results to set up variables like <code>num_orders</code>
and <code>total_funded</code>. It then uses these variables to populate the template
expressions like <code>{{num_orders}}</code>.</p>

<p>We use the <code>ng-show</code> directive to set up conditional logic on the basis of
whether or not the <code>OrdersCtrl</code> function call returned an error or not. If
it did not (<code>!error</code>) then we display the thermometer stats. If an error was
returned, we display an error message. Finally <code>ng-style</code> is used to apply a
CSS style to an element dynamically based on one of the variables set up by
<code>OrdersCtrl</code>, namely <code>percentage_funded</code>.</p>

<div class="highlight highlight-text-html-basic"><pre>  <span class="pl-c">&lt;!-- We define a new 'actions' div to contain statistics, order, and share buttons.--&gt;</span>
  &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>span5 actions<span class="pl-pds">"</span></span> <span class="pl-e">ng-controller</span>=<span class="pl-s"><span class="pl-pds">"</span>OrdersCtrl<span class="pl-pds">"</span></span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>row-fluid<span class="pl-pds">"</span></span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>span8 offset2<span class="pl-pds">"</span></span>&gt;
      &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>row-fluid statistics<span class="pl-pds">"</span></span>&gt;
        &lt;<span class="pl-ent">div</span> <span class="pl-e">ng-show</span>=<span class="pl-s"><span class="pl-pds">"</span>!error<span class="pl-pds">"</span></span>&gt;
          &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>span4<span class="pl-pds">"</span></span>&gt;
            <span class="pl-c">&lt;!-- linediv-l and linediv-r give dividing lines that look</span>
<span class="pl-c">            different in horizontal and vertical layouts, illustrating</span>
<span class="pl-c">            media queries. --&gt;</span>
            &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>linediv-l<span class="pl-pds">"</span></span>&gt;
            &lt;<span class="pl-ent">h3</span>&gt;{{num_orders}}&lt;/<span class="pl-ent">h3</span>&gt; &lt;<span class="pl-ent">p</span>&gt;backers&lt;/<span class="pl-ent">p</span>&gt;
            &lt;/<span class="pl-ent">div</span>&gt;
          &lt;/<span class="pl-ent">div</span>&gt;
          &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>span4<span class="pl-pds">"</span></span>&gt;
            &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>linediv-c<span class="pl-pds">"</span></span>&gt;
              &lt;<span class="pl-ent">h3</span>&gt;{{total_funded}}&lt;/<span class="pl-ent">h3</span>&gt; &lt;<span class="pl-ent">p</span>&gt;of {{target}} &lt;<span class="pl-ent">span</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>currency<span class="pl-pds">"</span></span>&gt;{{unit_symbol}}&lt;/<span class="pl-ent">span</span>&gt;&lt;/<span class="pl-ent">p</span>&gt;
            &lt;/<span class="pl-ent">div</span>&gt;
          &lt;/<span class="pl-ent">div</span>&gt;
          &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>span4<span class="pl-pds">"</span></span>&gt;
            &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>linediv-r<span class="pl-pds">"</span></span>&gt;
            &lt;<span class="pl-ent">h3</span>&gt;{{days_left}}&lt;/<span class="pl-ent">h3</span>&gt; &lt;<span class="pl-ent">p</span>&gt;days left&lt;/<span class="pl-ent">p</span>&gt;
            &lt;/<span class="pl-ent">div</span>&gt;
          &lt;/<span class="pl-ent">div</span>&gt;
        &lt;/<span class="pl-ent">div</span>&gt;
        &lt;<span class="pl-ent">div</span> <span class="pl-e">ng-show</span>=<span class="pl-s"><span class="pl-pds">"</span>error<span class="pl-pds">"</span></span>&gt;
          &lt;<span class="pl-ent">h3</span>&gt;{{error}}&lt;/<span class="pl-ent">h3</span>&gt;
        &lt;/<span class="pl-ent">div</span>&gt;
      &lt;/<span class="pl-ent">div</span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>row-fluid<span class="pl-pds">"</span></span> <span class="pl-e">ng-show</span>=<span class="pl-s"><span class="pl-pds">"</span>!error<span class="pl-pds">"</span></span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>span10 offset1<span class="pl-pds">"</span></span>&gt;
      <span class="pl-c">&lt;!-- Bootstrap progress bar --&gt;</span>
      <span class="pl-c">&lt;!-- http://twitter.github.io/bootstrap/components.html#progress --&gt;</span>
      &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>thermometer progress active<span class="pl-pds">"</span></span>&gt;
        &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>bar bar-success<span class="pl-pds">"</span></span> <span class="pl-e">ng-style</span>=<span class="pl-s"><span class="pl-pds">"</span>{'width': percentage_funded+'%'}<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">div</span>&gt;
        &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>bar bar-warning<span class="pl-pds">"</span></span> <span class="pl-e">ng-style</span>=<span class="pl-s"><span class="pl-pds">"</span>{'width': (100-percentage_funded)+'%'}<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">div</span>&gt;
      &lt;/<span class="pl-ent">div</span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>row-fluid<span class="pl-pds">"</span></span>&gt;
      &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>span6 offset3 order<span class="pl-pds">"</span></span>&gt;
        &lt;<span class="pl-ent">a</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>coinbase-button<span class="pl-pds">"</span></span> 
           <span class="pl-e">data-button-style</span>=<span class="pl-s"><span class="pl-pds">"</span>custom_large<span class="pl-pds">"</span></span> 
           <span class="pl-e">data-button-text</span>=<span class="pl-s"><span class="pl-pds">"</span>Preorder with Bitcoin<span class="pl-pds">"</span></span> 
           <span class="pl-e">data-custom</span>=<span class="pl-s"><span class="pl-pds">"</span>Finished order<span class="pl-pds">"</span></span>
           <span class="pl-e">data-code</span>=<span class="pl-s"><span class="pl-pds">"</span>&lt;%= coinbase_preorder_data_code %&gt;<span class="pl-pds">"</span></span> 
           <span class="pl-e">href</span>=<span class="pl-s"><span class="pl-pds">"</span>https://coinbase.com/checkouts/&lt;%= coinbase_preorder_data_code %&gt;<span class="pl-pds">"</span></span>&gt;Preorder with Bitcoin&lt;/<span class="pl-ent">a</span>&gt;
      &lt;/<span class="pl-ent">div</span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>row-fluid<span class="pl-pds">"</span></span>&gt;
    &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>span9 offset3 social<span class="pl-pds">"</span></span>&gt;
      <span class="pl-c">&lt;!-- AddThis Button BEGIN --&gt;</span>
      &lt;<span class="pl-ent">div</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>addthis_toolbox addthis_default_style<span class="pl-pds">"</span></span>&gt;
         &lt;<span class="pl-ent">a</span> <span class="pl-e">class</span>=<span class="pl-s"><span class="pl-pds">"</span>addthis_button_tweet<span class="pl-pds">"</span></span> <span class="pl-e">tw:via</span>=<span class="pl-s"><span class="pl-pds">"</span>&lt;%= twitter_username %&gt;<span class="pl-pds">"</span></span> <span class="pl-e">tw:text</span>=<span class="pl-s"><span class="pl-pds">"</span>&lt;%= twitter_tweet %&gt;<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">a</span>&gt;
      &lt;/<span class="pl-ent">div</span>&gt;
<span class="pl-s1">      &lt;<span class="pl-ent">script</span> <span class="pl-e">type</span>=<span class="pl-s"><span class="pl-pds">"</span>text/javascript<span class="pl-pds">"</span></span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>//s7.addthis.com/js/300/addthis_widget.js#pubid=xa-5214a5fe5dbdc2b4<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;</span>
      <span class="pl-c">&lt;!-- AddThis Button END --&gt;</span>
    &lt;/<span class="pl-ent">div</span>&gt;
    &lt;/<span class="pl-ent">div</span>&gt;
  &lt;/<span class="pl-ent">div</span>&gt;
  &lt;/<span class="pl-ent">div</span>&gt;
&lt;/<span class="pl-ent">div</span>&gt;</pre></div>

<p>To trace through the logic of how the thermometer data is populated, see the
<code>/api/orders</code> route in the next section.</p>

<h1>
<a id="figures" class="anchor" href="#figures" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Figures</h1>

<p>The following figures illustrate how the server-side and client-side
components of the app work together by tracing the path of the four routes
implemented in our app: <code>/</code>, <code>/api/order</code>, <code>/refresh_orders</code>, and
<code>/orders/</code>.</p>

<p>Warning: these figures are large. You can also download PDF versions here:
<a href="https://d396qusza40orc.cloudfront.net/startup/images/bitstarter-leaderboard/fig1.pdf">1</a>, <a href="https://d396qusza40orc.cloudfront.net/startup/images/bitstarter-leaderboard/fig2.pdf">2</a>, <a href="https://d396qusza40orc.cloudfront.net/startup/images/bitstarter-leaderboard/fig3.pdf">3</a>,
<a href="https://d396qusza40orc.cloudfront.net/startup/images/bitstarter-leaderboard/fig4.pdf">4</a>, <a href="https://d396qusza40orc.cloudfront.net/startup/images/bitstarter-leaderboard/fig5.pdf">5</a>. </p>

<h2>
<a id="the--route" class="anchor" href="#the--route" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The <code>/</code> route</h2>

<p>First, let's take a look at how an HTTP request to <code>example.com/</code> is handled
by our app. This about as simple as it gets in terms of generating a dynamic
HTTP response from an HTTP request; there's no database interaction and a
simple template is populated with some constant JSON data and returned to
the client.</p>

<div>
  <img width="100%" src="https://d396qusza40orc.cloudfront.net/startup/images/bitstarter-leaderboard/fig2.png">
</div>

<h2>
<a id="the-orders-route" class="anchor" href="#the-orders-route" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The <code>/orders</code> route</h2>

<p>Now let's look at a more complicated route, an HTTP request to
<code>/orders</code>. This request now involves hitting the database via the ORM and
using that data to populate the <code>orderpage.ejs</code> template. This is perhaps
the most common way to generate a dynamic response.</p>

<div>
  <img width="100%" src="https://d396qusza40orc.cloudfront.net/startup/images/bitstarter-leaderboard/fig3.png">
</div>

<h2>
<a id="the-refresh_orders-route" class="anchor" href="#the-refresh_orders-route" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The <code>/refresh_orders</code> route</h2>

<p>Now let's increase the level of complexity a little more, and show how to
implement a route that doesn't directly return an HTTP response, but that
redirects to the <code>/orders</code> route after performing a database operation.</p>

<div>
  <img width="100%" src="https://d396qusza40orc.cloudfront.net/startup/images/bitstarter-leaderboard/fig4.png">
</div>

<h2>
<a id="the-apiorders-route" class="anchor" href="#the-apiorders-route" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The <code>/api/orders</code> route</h2>

<p>Finally, let's take a look at a fairly sophisticated route. This route is
never meant to be called directly by the end user; it's actually used by the
client-side code in the thermometer on the front page to refresh itself from
the latest set of orders in the database.</p>

<div>
  <img width="100%" src="https://d396qusza40orc.cloudfront.net/startup/images/bitstarter-leaderboard/fig5.png">
</div>
      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>
